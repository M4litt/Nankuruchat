<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Test</title>
</head>
<body>
    <form id="form">
        <input type="text" placeholder="Username" autocomplete="off">
        <input type="submit" value="Login">
    </form>
    <div id="app" hidden>
        <div id="chat_container"></div>
        <div>
            <form id="message_form">
                <input id="message" type="text" placeholder="Message" autocomplete="off">
                <input id="submit" type="submit" value="Enviar">
            </form>
        </div>
    </div>
</body>

<style>
    body {
        margin: 5;
        padding-bottom: 3rem;
    }

    #chat_container {
        overflow-y: scroll;
        height: 90vh;
    }

    #message_form {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #message {
        width: 100%;
        height: 5vh;
    }

    #username {
        width: 20%;
        height: 5vh;
    }

    #submit {
        height: 6vh;
        border-radius: 0;
    }
</style>

<script>
    const message = document.querySelector('#message_form')
    const container = document.querySelector('#chat_container')
    const form = document.querySelector('#form')
    const app = document.querySelector('#app')
    const ws = new WebSocket('ws://172.16.255.220:4356')

    let ownName = ''

    const sendSignal = msg => {
        ws.send(JSON.stringify(msg))
    }

    const appendData = data => {
        container.innerHTML += `<p>${data}</p>`
        container.scrollTop = container.scrollHeight
    }

    const checkUname = data => {
        let reg = '/<(.|\n)*?>/g'
        if(data && data.replace(/\s/g, '').length) {
            return data
        }
        return 'the_nameless'
    }

    message.addEventListener('submit', event => {
        event.preventDefault()
        let data = message.children[0].value
        if(data && data.replace(/\s/g, '').length) {
            sendSignal({type: 'msg', content: data})
            appendData(`${ownName}: ${data}`)
            message.children[0].value = ''
        }
    })

    form.addEventListener('submit', e => {
        e.preventDefault()
        ownName = form.children[0].value
        sendSignal({type: 'login', name: checkUname(form.children[0].value)})
    })

    ws.addEventListener('message', msg => {
        const data = JSON.parse(msg.data)
    
        switch(data.type) {
            case 'login':
                if(data.success) {
                    form.hidden = true
                    app.hidden = false
                } else {
                    alert('Username already taken!')
                }
            break

            case 'message':
                appendData(`${data.name}: ${data.content}`)
            break
        }
    })


</script>

</html>